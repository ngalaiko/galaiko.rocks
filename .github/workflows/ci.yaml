name: CI

on:
  push: {}

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v1

    - name: Build image
      run: |
        docker build -t blog .

    - name: Run generation
      run: |
        docker run --rm -v /blog:/export blog sh -c 'cp -r /app/public/* /export'

    - name: Upload
      env:
        SFTP_USER: ${{ secrets.SFTP_USER }}
        SFTP_PASSWORD: ${{ secrets.SFTP_PASSWORD }}
      run: |
        find /blog -type f -exec curl \
            -T {} \
            --ftp-create-dirs \
            --user ${SFTP_USER}:${SFTP_PASSWORD} \
            "ftp://ftp.fastmail.com/nikita.galaiko.rocks/files/{}" ';'

